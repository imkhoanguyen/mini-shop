<p-toast></p-toast>

<div class="container my-5">
  <form [formGroup]="productForm">
    <div class="card p-4 shadow-sm">
      <h3 class="mb-4">{{ isUpdate ? 'Cập nhật sản phẩm' : 'Thêm sản phẩm' }}</h3>

      <div class="row">
        <div class="col-12 mb-4">
          <label for="name" class="form-label font-weight-bold">Tên:</label>
          <input pInputText id="name" class="form-control" autocomplete="on" formControlName="name" required />
          <div
            *ngIf="productForm.get('name')?.invalid && (productForm.get('name')?.touched || productForm.get('name')?.dirty)"
            class="text-danger">
            Tên sản phẩm là bắt buộc.
          </div>
        </div>

        <div class="col-12 mb-4">
          <label for="categories" class="form-label font-weight-bold">Danh Mục:</label>
          <p-multiSelect [options]="categories" formControlName="selectedCategories" placeholder="Chọn Danh Mục"
            optionLabel="name" optionValue="id" display="chip" [showClear]="true" [filter]="true"
            [style]="{ width: '100%' }" (onFilter)="onCategoryFilter($event)">
            <ng-template let-item pTemplate="item">{{ item.name }}</ng-template>

            <ng-template pTemplate="empty">
              <div class="no-data text-center">
                Không tìm thấy dữ liệu.
                <button (click)="addCategory()" class="btn btn-primary mt-2">
                  Thêm Danh Mục
                </button>
              </div>
            </ng-template>
          </p-multiSelect>
        </div>
      </div>

      <div class="mb-4">
        <label for="description" class="form-label font-weight-bold">Mô tả:</label>
        <textarea rows="5" pInputTextarea formControlName="description" class="form-control" required
          placeholder="Nhập mô tả..."></textarea>
      </div>

      <div class="mb-4">
        <label class="form-label font-weight-bold">Tải lên hình ảnh</label>
        <p-fileUpload name="images" url="https://www.primefaces.org/cdn/api/upload.php" [multiple]="false"
          accept="image/*" maxFileSize="1000000" (onSelect)="onSelectedFiles($event)" [style]="{ width: '100%' }">

          <ng-template pTemplate="header" let-files let-chooseCallback="chooseCallback"
            let-clearCallback="clearCallback">
            <div class="d-flex justify-content-between align-items-center">
              <p-button (click)="choose($event, chooseCallback)" icon="pi pi-images"
                class="p-button-rounded p-button-outlined" />
              <p-button (click)="clearCallback()" icon="pi pi-times" class="p-button-rounded p-button-danger"
                [disabled]="!files || files.length === 0" />
            </div>
          </ng-template>

          <ng-template pTemplate="empty">
            <div class="d-flex flex-column align-items-center">
              <i class="pi pi-cloud-upload text-muted display-1 mb-3"></i>
              <p class="text-muted">Kéo và thả tệp vào đây để tải lên.</p>
            </div>
          </ng-template>
        </p-fileUpload>
      </div>


    </div>

    <div class="card mt-5 p-4 shadow-sm">
      <h3 class="mb-4">Biến Thể</h3>
      <form [formGroup]="variantsForm">
      <div formArrayName="variants">
        <div *ngFor="let variant of variants.controls; let i = index" [formGroupName]="i"  class="mb-4">
          <p-accordion [activeIndex]="0">
            <p-accordionTab header="Biến thể {{i + 1}}">
              <div class="row mb-3">
                <div class="col-md-4 mb-3">
                  <p-inputNumber placeholder="Giá tiền" mode="currency" currency="VND" locale="en-US"
                    formControlName="price" class="pInputText" />
                </div>
                <div class="col-md-4 mb-3">
                  <p-inputNumber placeholder="Giá tiền giảm (nếu có)" mode="currency" currency="VND" locale="en-US"
                    formControlName="priceSell" class="pInputText" />
                </div>
                <div class="col-md-4 mb-3">
                  <p-inputNumber placeholder="Số lượng" mode="decimal" [useGrouping]="false" formControlName="quantity"
                    class="pInputText" />
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6 mb-3">
                  <p-dropdown [style]="{width: '100%'}" [options]="colors" formControlName="colorId"
                    placeholder="Chọn Màu Sắc" optionLabel="name" optionValue="id" [showClear]="true" [filter]="true"
                    (onFilter)="onColorFilter($event)">
                    <ng-template let-item pTemplate="item">{{ item.name }}</ng-template>
                    <ng-template pTemplate="empty">
                      <div class="no-data">
                        No data found.
                        <button (click)="showColorDialog()" class="btn btn-primary">Add Color</button>
                      </div>
                    </ng-template>
                  </p-dropdown>
                </div>

                <div class="col-md-6 mb-3">
                  <p-dropdown [style]="{width: '100%'}" [options]="sizes" formControlName="sizeId"
                    placeholder="Chọn Kích thước" optionLabel="name" optionValue="id" [showClear]="true" [filter]="true"
                    (onFilter)="onSizeFilter($event)">
                    <ng-template let-item pTemplate="item">{{ item.name }}</ng-template>
                    <ng-template pTemplate="empty">
                      <div class="no-data">
                        No data found.
                        <button (click)="addSize()" class="btn btn-primary">Add Size</button>
                      </div>
                    </ng-template>
                  </p-dropdown>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-12">
                  <label for="imageUpload" class="form-label">Tải lên hình ảnh</label>
                  <div class="card-body">
                    <p-fileUpload name="myfile[]" url="https://www.primefaces.org/cdn/api/upload.php" [multiple]="true"
                      accept="image/*" maxFileSize="1000000" (onSelect)="onSelectedVariantFiles($event,i)">
                      <ng-template pTemplate="header" let-files let-chooseCallback="chooseCallback"
                        let-clearCallback="clearCallback" let-uploadCallback="uploadCallback">
                        <div class="d-flex justify-content-between align-items-center">
                          <div class="d-flex gap-2">
                            <p-button (onClick)="choose($event, chooseCallback)" icon="pi pi-images" [rounded]="true"
                              [outlined]="true" />
                            <p-button (onClick)="clearCallback()" icon="pi pi-times" [rounded]="true" [outlined]="true"
                              severity="danger" [disabled]="!files || files.length === 0" />
                          </div>
                          <p-progressBar [value]="totalSizePercent" [showValue]="false"
                            styleClass="md:w-20rem h-1rem w-full"
                            [ngClass]="{ 'exceeded-progress-bar': totalSizePercent > 100 }">
                            <span class="white-space-nowrap">{{ totalSize }}B / 1Mb</span>
                          </p-progressBar>
                        </div>
                      </ng-template>

                      <ng-template pTemplate="empty">
                        <div class="d-flex flex-column align-items-center justify-content-center">
                          <i class="pi pi-cloud-upload border-2 border-circle p-5 text-8xl text-400 border-400"></i>
                          <p class="mt-4 mb-0">Kéo và thả tệp vào đây để tải lên.</p>
                        </div>
                      </ng-template>
                    </p-fileUpload>
                  </div>
                </div>
              </div>
              <div class="col-12 mt-2">
                <p-button label="Xóa Biến Thể" icon="pi pi-trash" class="p-button-danger"
                  (click)="removeVariant(i)"></p-button>
              </div>

            </p-accordionTab>
          </p-accordion>

        </div>
      </div>
    </form>
    </div>
    <div class="d-flex justify-content-end mt-4">
      <p-button label="Thêm Biến Thể" icon="pi pi-plus" (click)="addVariant()"></p-button>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <p-button label="{{ isUpdate ? 'Cập nhật sản phẩm' : 'Thêm sản phẩm' }}"
        icon="{{ isUpdate ? 'pi pi-pencil' : 'pi pi-plus' }}" (click)="onSubmit()">
      </p-button>
    </div>

  </form>
</div>

<p-dialog header="Thêm màu" [(visible)]="visible" [modal]="true" [style]="{ width: '25rem' }">
  <div class="form-group">
    <label for="name">Tên Màu</label>
    <input pInputText id="name" [(ngModel)]="name" class="form-control" />
  </div>
  <div class="form-group mt-3">
    <label for="code">Mã Màu</label>
    <p-colorPicker [(ngModel)]="code" class="w-100"></p-colorPicker>
  </div>
  <div class="d-flex justify-content-end mt-3 gap-2">
    <p-button label="Hủy" class="p-button-secondary" (click)="visible = false"></p-button>
    <p-button label="Thêm" (click)="addColor()"></p-button>
  </div>
</p-dialog>
